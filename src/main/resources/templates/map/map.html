<!DOCTYPE html>
<html>
<head>

    <style>
        .main {
            width: 700px;
            height: 700px;
            margin: auto;
            margin-top: 100px;
        }

        table {
            text-align: center;
        }

        .register {
            text-align: center;
            display: inline-block;
            border: 1px solid;
            width: 80px;
            height: 30px;
            background-color: mistyrose;
            text-decoration: none;
            line-height: 30px;
        }

        ul {
            text-align: center;
            margin-top: 20px;
        }

        ul li {
            list-style-type: none;
            display: inline-block;
            margin-right: 10px;
        }

    </style>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>간단한 지도 표시하기</title>
    <script type="text/javascript"
            src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=vx49grqpqr"></script>
    <script
            src="https://code.jquery.com/jquery-3.6.1.js"
            integrity="sha256-3zlB5s2uwoUzrXK3BT7AX3FyvojsraNFxCc2vC/7pNI="
            crossorigin="anonymous">

    </script>


</head>
<body>

<!-- 네이버 지도가 뿌려질 곳 !  -->
<div id="map" style="width:100%;height:75vh; margin: 0 auto;"></div>
<div id="mapsTable">

    <ul>
        <tr th:each="chargingStationData: ${maps}">
            <td>
                <a th:text="|${chargingStationData.addr}|"></a>
            </td>
            <td>
                <li th:each="chargerDTO: ${chargingStationData.chargerList}">
                    <span th:text="|${chargerDTO.stat}|"></span>
                </li>
            </td>


        </tr>


    </ul>

    <!-- Page Marker -->

</div>


<div class="main">

    <table>
        <colgroup>
            <col width="50">
            <col width="300">
            <col width="150">
            <col width="200">
        </colgroup>
        <thead>
        <tr>

            <th>충전소id</th>
            <th>충전기id</th>
            <th>상태</th>

        </tr>
        </thead>
        <tbody>
        <tr th:each="board : ${board}">
            <td th:text="${board.statId}"></td>
            <td th:text="${board.chgerId}"></td>
            <td th:text="${board.stat}"></td>
        </tbody>
    </table>

    <div class="pagination">
        <ul>
            <li th:each="page : ${#numbers.sequence(0, totalPage - 1)}">
                <a th:href="@{/list(page=${pageStat.index})}" th:text="${pageStat.index + 1}"></a>
            </li>
        </ul>
    </div>
</div>

</body>


<script type="text/javascript">
    let lat;
    let lng;
    let areaArr = new Array();  // 지역을 담는 배열 ( 지역명/위도경도 )
    let map
    $(function () {

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (pos) {
                lat = pos.coords.latitude;
                lng = pos.coords.longitude;
                alert("현재 위치는 : " + lat + ", " + lng);
                $.ajax({
                    url: '/address',
                    type: 'POST',
                    data:
                        {
                            "lat": lat,
                            "lng": lng
                        },
                    beforeSend: function (jqXHR) {
                        console.log("ajax호출전");
                    },// 서버 요청 전 호출 되는 함수 return false; 일 경우 요청 중단
                    success: function (data) {
                        console.log("호출성공");
                        //  $("#mapsTable").replaceWith(data);

                    },// 요청 완료 시
                    error: function (jqXHR) {
                        console.log("실패입니다.");
                    }// 요청 실패.
                });


                $.ajax({
                    url: '/apitest',
                    type: 'POST',
                    data:
                        {
                            "lat": lat,
                            "lng": lng
                        },
                    beforeSend: function (jqXHR) {
                        console.log("ajax호출전");
                    },// 서버 요청 전 호출 되는 함수 return false; 일 경우 요청 중단
                    success: function (data) {
                        map = new naver.maps.Map('map', {
                            center: new naver.maps.LatLng(lat, lng), //지도 시작 지점
                            zoom: 15
                        });
                        console.log("호출성공");
                        $(data).each(function () {
                            //console.log(this.zcode + " " + this.lat + " " + this.lng+" "+this.statId+" "+this.addr);

                            areaArr.push({
                                "lat": this.lat,
                                "lng": this.lng,
                                "zcode": this.zcode,
                                "addr": this.addr,
                                "stat_id": this.statId
                            })
                        });
                        initMap();

                    },// 요청 완료 시
                    error: function (jqXHR) {
                        console.log("실패입니다.");
                    }// 요청 실패.
                });
            });

        }


    });

    function initMap() {
        let markers = new Array(); // 마커 정보를 담는 배열
        let infoWindows = new Array(); // 정보창을 담는 배열
        for (let i = 0; i < areaArr.length; i++) {
            // 지역을 담은 배열의 길이만큼 for문으로 마커와 정보창을 채워주자 !
            console.log("와우");
            let marker = new naver.maps.Marker({
                map: map,
                title: areaArr[i].lat, // 지역구 이름
                position: new naver.maps.LatLng(areaArr[i].lat, areaArr[i].lng) // 지역구의 위도 경도 넣기
            });
            console.log(areaArr[i].lat + " " + areaArr[i].lng);

            /* 정보창 */
            /*
            let infoWindow = new naver.maps.InfoWindow({
                content: '<div style="width:200px;text-align:center;padding:10px;"><b><br> - 네이버 지도 - </div>'
            }); // 클릭했을 때 띄워줄 정보 HTML 작성
            */

            markers.push(marker); // 생성한 마커를 배열에 담는다.
            //infoWindows.push(infoWindow); // 생성한 정보창을 배열에 담는다.
        }


        function getClickHandler(seq) {


            return function (e) {  // 마커를 클릭하는 부분
                let marker = markers[seq], // 클릭한 마커의 시퀀스로 찾는다.
                    // infoWindow = infoWindows[seq]; // 클릭한 마커의 시퀀스로 찾는다
                    infoWindow = new naver.maps.InfoWindow({
                        content: '<div style="width:200px;text-align:center;padding:10px;"><b>' + areaArr[seq].zcode + '<b></b> - 네이버 지도 - </div>'
                    })
                if (infoWindow.getMap()) {

                    infoWindow.close();
                } else {
                    infoWindow.open(map, marker); // 표출
                    $.ajax({
                        url: '/statusWindow',
                        type: 'POST',
                        data:
                            {
                                "statid": areaArr[seq].stat_id,
                                "zcode": areaArr[seq].zcode
                            },
                        beforeSend: function (jqXHR) {
                            console.log("ajax호출전");
                        },// 서버 요청 전 호출 되는 함수 return false; 일 경우 요청 중단
                        success: function (data) {
                            console.log("호출성공");
                            $(data).each(function () {
                                console.log(this.chgerId);
                            });
                        },// 요청 완료 시
                        error: function (jqXHR) {
                            console.log("실패입니다.");
                        }// 요청 실패.
                    });
                }
            }
        }

        for (let i = 0, ii = markers.length; i < ii; i++) {
            console.log(markers[i], getClickHandler(i));
            naver.maps.Event.addListener(markers[i], 'click', getClickHandler(i)); // 클릭한 마커 핸들러
        }
    }


</script>

</html>